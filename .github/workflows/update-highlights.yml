name: Update Highlights Page

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-highlights:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
      
    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64
      
    - name: Build MinSizeRel
      run: cmake --build build --config MinSizeRel
      
    - name: Download cloc
      run: Invoke-WebRequest -Uri "https://github.com/AlDanial/cloc/releases/download/v1.98/cloc-1.98.exe" -OutFile cloc.exe
      shell: pwsh
      
    - name: Collect metrics and update highlights
      run: |
        # Get current date
        $date = Get-Date -Format "yyyy-MM-dd"
        
        # Get binary size
        $binarySize = (Get-Item "bin/MinSizeRel/goblin-stream.exe").Length
        $binarySizeFormatted = "{0:N0}" -f $binarySize
        
        # Get source line count
        $clocOutput = ./cloc.exe src --json | Out-String
        $clocJson = $clocOutput | ConvertFrom-Json
        $sourceLines = $clocJson.SUM.code
        
        # Get current commit SHA (short)
        $currentCommit = git rev-parse --short HEAD
        
        # Get files changed since last highlights update
        # Try to find the last commit that updated refactor-highlights.html
        $lastHighlightsCommit = git log -1 --format="%H" -- refactor-highlights.html 2>$null
        if ($lastHighlightsCommit) {
          $baseCommit = git rev-parse --short $lastHighlightsCommit
          $filesChanged = (git diff --name-only $lastHighlightsCommit HEAD | Measure-Object).Count
        } else {
          # If no previous highlights commit, use the root commit
          $rootCommit = git rev-list --max-parents=0 HEAD
          $baseCommit = git rev-parse --short $rootCommit
          $filesChanged = (git diff --name-only $rootCommit HEAD | Measure-Object).Count
        }
        
        Write-Output "Date: $date"
        Write-Output "Binary Size: $binarySize bytes ($binarySizeFormatted)"
        Write-Output "Source Lines: $sourceLines"
        Write-Output "Current Commit: $currentCommit"
        Write-Output "Base Commit: $baseCommit"
        Write-Output "Files Changed: $filesChanged"
        
        # Read the current highlights HTML
        $htmlContent = Get-Content "refactor-highlights.html" -Raw
        
        # Update the title with current commit (match SHA pattern more specifically)
        $htmlContent = $htmlContent -replace '<h1>Refactor Highlights since <code>[a-f0-9]{7,40}</code></h1>', "<h1>Refactor Highlights since <code>$baseCommit</code></h1>"
        
        # Update the comparison range and date
        $htmlContent = $htmlContent -replace '<p class="subtitle">Compared range: <code>[a-f0-9]{7,40}\.\.[a-zA-Z0-9_-]+</code> · generated on [\d-]+</p>', "<p class=`"subtitle`">Compared range: <code>$baseCommit..$currentCommit</code> · generated on $date</p>"
        
        # Update files changed count (flexible whitespace)
        $htmlContent = $htmlContent -replace '(<div class="k">Files changed</div>\s*<div class="v">)\d+', "`${1}$filesChanged"
        
        # Update binary size (flexible whitespace)
        $htmlContent = $htmlContent -replace '(<div class="k">MinSizeRel binary</div>\s*<div class="v">)[\d,]+\s*bytes', "`${1}$binarySizeFormatted bytes"
        
        # Update source lines count (flexible whitespace)
        $htmlContent = $htmlContent -replace '(<div class="k">cloc total in /src</div>\s*<div class="v">)\d+\s*lines', "`${1}$sourceLines lines"
        
        # Update binary size in build status section (flexible whitespace)
        $htmlContent = $htmlContent -replace '(Binary size \(MinSizeRel\):\s*<code>)[\d,]+', "`${1}$binarySizeFormatted"
        
        # Update source lines in build status section (flexible whitespace)
        $htmlContent = $htmlContent -replace '(cloc /src total:\s*<code>)\d+', "`${1}$sourceLines"
        
        # Add new entry to build log (insert after the opening <ul> tag in the build log section)
        $newLogEntry = "                    <li>$date · MinSizeRel size: <code>$binarySizeFormatted</code> bytes · cloc /src: <code>$sourceLines</code> lines · build succeeded.</li>"
        $htmlContent = $htmlContent -replace '(<h2>Build log</h2>\s*<div class="panel">\s*<ul>)', "`${1}`n$newLogEntry"
        
        # Validate that critical replacements succeeded
        $validationErrors = @()
        if (-not ($htmlContent -match "since <code>$baseCommit</code>")) {
            $validationErrors += "Title update failed"
        }
        if (-not ($htmlContent -match "$baseCommit\.\.$currentCommit")) {
            $validationErrors += "Comparison range update failed"
        }
        if (-not ($htmlContent -match "generated on $date")) {
            $validationErrors += "Generation date update failed"
        }
        
        if ($validationErrors.Count -gt 0) {
            Write-Error "Validation failed: $($validationErrors -join ', ')"
            Write-Error "HTML updates may have failed due to unexpected structure changes"
            exit 1
        }
        
        # Save the updated HTML
        $htmlContent | Set-Content "refactor-highlights.html" -NoNewline
        
        Write-Output "Highlights page updated successfully"
      shell: pwsh
      
    - name: Commit and push changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add refactor-highlights.html
        
        # Check if there are staged changes
        git diff --staged --quiet
        if ($LASTEXITCODE -ne 0) {
          # There are changes, commit them
          git commit -m "Update highlights page with latest metrics"
          git push
          Write-Output "Changes committed and pushed"
        } else {
          Write-Output "No changes to commit"
        }
      shell: pwsh
