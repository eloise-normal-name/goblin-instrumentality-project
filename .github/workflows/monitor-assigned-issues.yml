name: Monitor Assigned Issues

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  issues:
    types: [assigned, edited, labeled, unlabeled]
  issue_comment:
    types: [created, edited]

permissions:
  issues: write
  contents: read

jobs:
  check_assigned_issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for updates on assigned issues
        uses: actions/github-script@v7
        with:
          script: |
            const botUsers = ['copilot', 'copilot-swe-agent[bot]', 'github-actions[bot]'];
            
            // If triggered by an event, check the specific issue
            if (context.eventName === 'issues' || context.eventName === 'issue_comment') {
              const issue = context.payload.issue;
              const assignees = issue.assignees.map(a => a.login);
              
              // Check if any bot is assigned
              const hasBotAssigned = botUsers.some(bot => assignees.includes(bot));
              
              if (!hasBotAssigned) {
                core.info(`Issue #${issue.number} is not assigned to a bot. Skipping.`);
                return;
              }
              
              core.info(`Issue #${issue.number} is assigned to a bot and has been updated.`);
              
              // Get recent comments
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                per_page: 10
              });
              
              const recentComments = comments.data.slice(-5);
              const lastBotComment = recentComments.slice().reverse().find(c => 
                botUsers.some(bot => c.user.login.includes(bot))
              );
              
              // Check if there are new user comments since last bot comment
              const userCommentsSinceBot = lastBotComment 
                ? recentComments.filter(c => 
                    new Date(c.created_at) > new Date(lastBotComment.created_at) &&
                    !botUsers.some(bot => c.user.login.includes(bot))
                  )
                : recentComments.filter(c => !botUsers.some(bot => c.user.login.includes(bot)));
              
              if (userCommentsSinceBot.length > 0) {
                core.info(`Found ${userCommentsSinceBot.length} new user comments since last bot interaction.`);
                
                // Add a label to indicate the issue needs attention
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['needs-bot-attention']
                  });
                  core.info('Added "needs-bot-attention" label.');
                } catch (error) {
                  core.warning(`Failed to add label: ${error.message}`);
                }
              }
            } else {
              // Scheduled run - check all open issues assigned to bots
              core.info('Running scheduled check of all assigned issues...');
              
              for (const botUser of botUsers) {
                try {
                  const issues = await github.rest.issues.listForRepo({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    assignee: botUser,
                    state: 'open',
                    per_page: 100
                  });
                  
                  core.info(`Found ${issues.data.length} open issues assigned to ${botUser}`);
                  
                  for (const issue of issues.data) {
                    // Get comments for this issue
                    const comments = await github.rest.issues.listComments({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      per_page: 100
                    });
                    
                    const allComments = comments.data;
                    const lastBotComment = allComments.slice().reverse().find(c => 
                      botUsers.some(bot => c.user.login.includes(bot))
                    );
                    
                    const userCommentsSinceBot = lastBotComment 
                      ? allComments.filter(c => 
                          new Date(c.created_at) > new Date(lastBotComment.created_at) &&
                          !botUsers.some(bot => c.user.login.includes(bot))
                        )
                      : allComments.filter(c => !botUsers.some(bot => c.user.login.includes(bot)));
                    
                    // Check if issue has been updated since last bot interaction
                    const issueUpdated = new Date(issue.updated_at);
                    const lastBotActivity = lastBotComment ? new Date(lastBotComment.created_at) : new Date(issue.created_at);
                    
                    if (userCommentsSinceBot.length > 0 || issueUpdated > lastBotActivity) {
                      core.info(`Issue #${issue.number} has updates: ${userCommentsSinceBot.length} new comments, last updated ${issue.updated_at}`);
                      
                      // Add label to indicate attention needed
                      const hasLabel = issue.labels.some(l => l.name === 'needs-bot-attention');
                      if (!hasLabel) {
                        try {
                          await github.rest.issues.addLabels({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: issue.number,
                            labels: ['needs-bot-attention']
                          });
                          core.info(`Added "needs-bot-attention" label to issue #${issue.number}`);
                        } catch (error) {
                          core.warning(`Failed to add label to issue #${issue.number}: ${error.message}`);
                        }
                      }
                    }
                  }
                } catch (error) {
                  core.warning(`Error checking issues for ${botUser}: ${error.message}`);
                }
              }
            }

