name: Format Check

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  format:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install LLVM (includes clang-format)
      run: choco install llvm -y
      
    - name: Check formatting
      run: |
        # Verify .clang-format file exists
        if (!(Test-Path ".clang-format")) {
          Write-Output "::error::.clang-format file not found in repository root"
          exit 1
        }
        
        Write-Output "Using .clang-format from repository root"
        Get-Content ".clang-format" | Select-Object -First 5
        Write-Output ""
        
        $files = Get-ChildItem -Path src,include -Include *.cpp,*.ixx,*.h -Recurse | Where-Object { $_.FullName -notmatch "nvEncodeAPI\.h" }
        $failed = @()
        
        foreach ($file in $files) {
          $original = Get-Content $file.FullName -Raw
          # Explicitly use -style=file to ensure .clang-format is used
          $formatted = & clang-format -style=file $file.FullName
          
          if ($original -ne $formatted) {
            $failed += $file.FullName
            Write-Output "::error file=$($file.FullName)::File is not formatted according to .clang-format"
          }
        }
        
        if ($failed.Count -gt 0) {
          Write-Output "The following files need formatting:"
          $failed | ForEach-Object { Write-Output "  - $_" }
          Write-Output ""
          Write-Output "Run 'clang-format -i -style=file <file>' to format these files"
          exit 1
        }
        
        Write-Output "All files are properly formatted âœ“"
      shell: pwsh
