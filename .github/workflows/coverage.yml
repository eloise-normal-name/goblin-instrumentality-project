name: Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  coverage:
    runs-on: windows-latest
    permissions:
      contents: read
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Install OpenCppCoverage
      run: |
        choco install opencppcoverage -y
        echo "C:\Program Files\OpenCppCoverage" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64
    
    - name: Build
      run: cmake --build build --config Debug
    
    - name: Run Coverage
      run: |
        OpenCppCoverage --sources "src\*" --export_type cobertura:coverage.xml -- bin\Debug\goblin-stream.exe --headless
      continue-on-error: true
    
    - name: Upload crash log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: crash-diagnostics
        path: crash_log.txt
        if-no-files-found: ignore
        retention-days: 7
    
    - name: Display crash log
      if: always()
      run: |
        if (Test-Path crash_log.txt) {
          Write-Host "=== Crash Diagnostics Log ===" -ForegroundColor Yellow
          Get-Content crash_log.txt
          Write-Host "=== End of Crash Log ===" -ForegroundColor Yellow
        } else {
          Write-Host "No crash log found (application may have exited normally)" -ForegroundColor Green
        }
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    
    - name: Archive coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.xml
        retention-days: 30
