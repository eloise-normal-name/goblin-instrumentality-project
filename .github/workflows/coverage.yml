name: Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  coverage:
    runs-on: windows-latest
    permissions:
      contents: read
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Install OpenCppCoverage
      run: |
        choco install opencppcoverage -y
        echo "C:\Program Files\OpenCppCoverage" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64
    
    - name: Build
      run: cmake --build build --config Debug
    
    - name: Run Coverage
      # NOTE: Coverage is currently skipped because no tests exist yet.
      # The application requires DirectX 12 and a GUI environment to run.
      # When tests are added, update this step to run the test executable instead.
      # Example: OpenCppCoverage --sources "src\*" -- bin\Debug\goblin-stream-tests.exe
      run: |
        Write-Host "Coverage infrastructure is configured."
        Write-Host "Coverage will run automatically when tests are added."
        Write-Host "See docs/TEST_COVERAGE_INTEGRATION.md for integration guidance."
        exit 0
      continue-on-error: false
    
    - name: Upload coverage to Codecov
      # Skip until tests are added and coverage.xml is generated
      if: false
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    
    - name: Archive coverage report
      # Skip until tests are added and coverage.xml is generated
      if: false
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.xml
        retention-days: 30
