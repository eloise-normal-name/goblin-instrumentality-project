name: Gobbo Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gobbo-review:
    name: Gobbo Elegant Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Gobbo Review
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });
            
            // Get diff/files changed
            const { data: files } = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: prNumber
            });
            
            // Filter for C++ source files
            const cppFiles = files.filter(f => 
              f.filename.match(/\.(cpp|h|ixx|hpp)$/)
            );
            
            if (cppFiles.length === 0) {
              core.info('No C++ files changed, skipping Gobbo review');
              return;
            }
            
            // Calculate code size metrics
            let additions = 0;
            let deletions = 0;
            cppFiles.forEach(f => {
              additions += f.additions;
              deletions += f.deletions;
            });
            
            // Create review comment
            const reviewBody = `## Gobbo Code Review ðŸŽ¨âœ¨
            
            **Code Size**: +${additions}/-${deletions} lines across ${cppFiles.length} file(s)
            
            I'm Gobbo, your elegant C++ code artist! I'll be reviewing this PR for:
            - **Conciseness**: Every line must earn its place
            - **Readability**: Code should read like poetry
            - **Elegance**: Simplicity is beauty
            - **RAII compliance**: Proper resource management
            - **Zero waste**: No redundant operations
            
            Files under review:
            ${cppFiles.map(f => \`- \${f.filename} (+\${f.additions}/-\${f.deletions})\`).join('\n')}
            
            *Remember: The best code is code that never needs to be written. Make every line count!*
            
            ---
            *Review triggered by Gobbo agent profile at \`.github/agents/gobbo.agent.md\`*`;
            
            // Post review comment
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: reviewBody
            });
            
            core.info(\`Gobbo review posted for PR #\${prNumber}\`);
