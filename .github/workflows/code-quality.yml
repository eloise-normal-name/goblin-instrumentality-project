name: Code Quality Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  check-naming-conventions:
    name: Check Naming Conventions
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for snake_case method names
        shell: pwsh
        run: |
          $violations = @()
          
          Get-ChildItem -Path src -Recurse -Include *.cpp,*.h,*.ixx | ForEach-Object {
            $file = $_.FullName
            $relativePath = $_.FullName.Replace("$PWD\", "")
            $lineNum = 0
            
            Get-Content $file | ForEach-Object {
              $lineNum++
              $line = $_
              
              # Check for method declarations with snake_case (private/public methods)
              # Matches: void/auto/HRESULT/etc. ClassName::method_name( or method_name(
              if ($line -match '^\s*(void|auto|int|bool|HRESULT|HANDLE|ComPtr(<[^>]+>)?|std::\w+|ID3D\w+\*?|NV_\w+)\s+(\w+::)?([a-z][a-z0-9]*_[a-z0-9_]+)\s*\(') {
                $methodName = $Matches[4]
                $violations += "${relativePath}:${lineNum}: Method '$methodName' uses snake_case (should be PascalCase)"
              }
            }
          }
          
          if ($violations.Count -gt 0) {
            Write-Host "❌ Naming convention violations found:" -ForegroundColor Red
            $violations | ForEach-Object { Write-Host $_ -ForegroundColor Yellow }
            Write-Host ""
            Write-Host "Methods must use PascalCase (e.g., CreateDevice, not create_device)" -ForegroundColor Cyan
            exit 1
          } else {
            Write-Host "✅ All method names follow PascalCase convention" -ForegroundColor Green
          }

  check-prohibited-patterns:
    name: Check Prohibited Patterns
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for C++ casts
        shell: pwsh
        run: |
          $violations = @()
          
          Get-ChildItem -Path src -Recurse -Include *.cpp,*.h,*.ixx | ForEach-Object {
            $file = $_.FullName
            $relativePath = $_.FullName.Replace("$PWD\", "")
            $lineNum = 0
            
            Get-Content $file | ForEach-Object {
              $lineNum++
              $line = $_
              
              # Check for C++ casts (static_cast, const_cast, dynamic_cast, reinterpret_cast)
              if ($line -match '(static_cast|const_cast|dynamic_cast|reinterpret_cast)\s*<') {
                $castType = $Matches[1]
                $violations += "${relativePath}:${lineNum}: C++ cast '$castType' found (use C-style casts)"
              }
            }
          }
          
          if ($violations.Count -gt 0) {
            Write-Host "❌ Prohibited C++ casts found:" -ForegroundColor Red
            $violations | ForEach-Object { Write-Host $_ -ForegroundColor Yellow }
            Write-Host ""
            Write-Host "Use C-style casts (Type)value instead of C++ casts" -ForegroundColor Cyan
            exit 1
          } else {
            Write-Host "✅ No prohibited C++ casts found" -ForegroundColor Green
          }

      - name: Check for namespace usage
        shell: pwsh
        run: |
          $violations = @()
          
          Get-ChildItem -Path src -Recurse -Include *.cpp,*.h,*.ixx | ForEach-Object {
            $file = $_.FullName
            $relativePath = $_.FullName.Replace("$PWD\", "")
            $lineNum = 0
            
            Get-Content $file | ForEach-Object {
              $lineNum++
              $line = $_
              
              # Check for namespace declarations
              if ($line -match '^\s*namespace\s+\w+\s*\{') {
                $violations += "${relativePath}:${lineNum}: Namespace declaration found (namespaces prohibited)"
              }
            }
          }
          
          if ($violations.Count -gt 0) {
            Write-Host "❌ Namespace declarations found:" -ForegroundColor Red
            $violations | ForEach-Object { Write-Host $_ -ForegroundColor Yellow }
            Write-Host ""
            Write-Host "Namespaces are prohibited - keep all code in global namespace" -ForegroundColor Cyan
            exit 1
          } else {
            Write-Host "✅ No namespace declarations found" -ForegroundColor Green
          }

      - name: Check for Initialize/Shutdown methods
        shell: pwsh
        run: |
          $violations = @()
          
          Get-ChildItem -Path src -Recurse -Include *.cpp,*.h,*.ixx | ForEach-Object {
            $file = $_.FullName
            $relativePath = $_.FullName.Replace("$PWD\", "")
            $lineNum = 0
            
            Get-Content $file | ForEach-Object {
              $lineNum++
              $line = $_
              
              # Check for Initialize or Shutdown method declarations
              if ($line -match '\b(Initialize|Shutdown)\s*\(') {
                $violations += "${relativePath}:${lineNum}: Two-phase initialization method found (violates RAII)"
              }
            }
          }
          
          if ($violations.Count -gt 0) {
            Write-Host "❌ Two-phase initialization methods found:" -ForegroundColor Red
            $violations | ForEach-Object { Write-Host $_ -ForegroundColor Yellow }
            Write-Host ""
            Write-Host "Use constructor/destructor pairs instead of Initialize/Shutdown methods" -ForegroundColor Cyan
            exit 1
          } else {
            Write-Host "✅ No Initialize/Shutdown methods found" -ForegroundColor Green
          }

      - name: Check for trailing underscores
        shell: pwsh
        run: |
          $violations = @()
          
          Get-ChildItem -Path src -Recurse -Include *.cpp,*.h,*.ixx | ForEach-Object {
            $file = $_.FullName
            $relativePath = $_.FullName.Replace("$PWD\", "")
            $lineNum = 0
            
            Get-Content $file | ForEach-Object {
              $lineNum++
              $line = $_
              
              # Check for variable names with trailing underscores
              if ($line -match '\b([a-z_][a-z0-9_]*_)\s*(=|;|\))') {
                $varName = $Matches[1]
                if ($varName -match '_$') {
                  $violations += "${relativePath}:${lineNum}: Variable with trailing underscore found: '$varName'"
                }
              }
            }
          }
          
          if ($violations.Count -gt 0) {
            Write-Host "❌ Variables with trailing underscores found:" -ForegroundColor Red
            $violations | ForEach-Object { Write-Host $_ -ForegroundColor Yellow }
            Write-Host ""
            Write-Host "Use plain snake_case without trailing underscores for member variables" -ForegroundColor Cyan
            exit 1
          } else {
            Write-Host "✅ No trailing underscores found" -ForegroundColor Green
          }
