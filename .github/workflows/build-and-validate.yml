name: Build and Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
      
    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64
      
    - name: Build Debug
      run: cmake --build build --config Debug
      
    - name: Build Release
      run: cmake --build build --config Release
      
    - name: Build MinSizeRel
      run: cmake --build build --config MinSizeRel
      
    - name: Check binary exists
      run: |
        if (!(Test-Path "bin/MinSizeRel/goblin-stream.exe")) {
          Write-Error "MinSizeRel binary not found"
          exit 1
        }
      shell: pwsh
      
    - name: Report binary size
      run: |
        $size = (Get-Item "bin/MinSizeRel/goblin-stream.exe").Length
        Write-Output "MinSizeRel binary size: $size bytes"
        Write-Output "BINARY_SIZE=$size" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: Install cloc
      run: choco install cloc -y
      
    - name: Count source lines
      run: |
        $output = cloc src --json
        $json = $output | ConvertFrom-Json
        $total = $json.SUM.code
        Write-Output "Total source lines in /src: $total"
        Write-Output "SOURCE_LINES=$total" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: goblin-stream-binaries
        path: |
          bin/Debug/goblin-stream.exe
          bin/Release/goblin-stream.exe
          bin/MinSizeRel/goblin-stream.exe
        retention-days: 7
      
    - name: Create build summary
      run: |
        Write-Output "### Build Summary" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- **MinSizeRel binary size**: $env:BINARY_SIZE bytes" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- **Source lines (cloc /src)**: $env:SOURCE_LINES lines" >> $env:GITHUB_STEP_SUMMARY
      shell: pwsh

  notify:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ always() && needs.build.result != 'success' && github.event_name == 'pull_request' }}
    
    steps:
    - name: Comment on workflow failure
      uses: actions/github-script@v7
      env:
        RESULT: ${{ needs.build.result }}
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
          const body = [
            'Build and Validate workflow did not succeed.',
            `Result: ${process.env.RESULT}`,
            `Logs: ${runUrl}`
          ].join('\n');
          const existing = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            per_page: 100
          });
          if (existing.data.some(comment => comment.body && comment.body.includes(runUrl))) {
            core.info('Comment for this run already exists.');
            return;
          }
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body
          });
