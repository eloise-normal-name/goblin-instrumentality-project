name: Auto-Approve Bot Workflow Runs

on:
  workflow_run:
    workflows:
      - "Build and Validate"
      - "Run App and Log Output"
      - "Code Quality Checks"
      - "Docs Index Check"
    types:
      - requested

permissions:
  actions: write
  contents: read

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    # Only run for pull_request or push events from bot PRs
    if: |
      github.event.workflow_run.event == 'pull_request' ||
      github.event.workflow_run.event == 'push'
    
    steps:
      - name: Check if actor is trusted bot
        id: check_bot
        run: |
          ACTOR="${{ github.event.workflow_run.actor.login }}"
          echo "Actor: $ACTOR"
          
          # Define trusted bots
          TRUSTED_BOTS=("Copilot" "copilot[bot]" "copilot-swe-agent[bot]" "github-actions[bot]" "eloise-normal-name")
          
          IS_TRUSTED=false
          for bot in "${TRUSTED_BOTS[@]}"; do
            if [ "$ACTOR" == "$bot" ]; then
              IS_TRUSTED=true
              break
            fi
          done
          
          if [ "$IS_TRUSTED" = true ]; then
            echo "✓ Actor is a trusted bot"
            echo "is_trusted=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️  Actor '$ACTOR' is not a trusted bot. Skipping auto-approval."
            echo "is_trusted=false" >> $GITHUB_OUTPUT
          fi

      - name: Check token configuration
        id: check_token
        if: steps.check_bot.outputs.is_trusted == 'true'
        env:
          TOKEN_CHECK: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN }}
        run: |
          if [ -z "$TOKEN_CHECK" ]; then
            echo "⚠️  COPILOT_MCP_GITHUB_TOKEN not configured"
            echo "token_exists=false" >> $GITHUB_OUTPUT
          else
            echo "✓ COPILOT_MCP_GITHUB_TOKEN configured"
            echo "token_exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate token permissions
        id: validate_token
        if: |
          steps.check_bot.outputs.is_trusted == 'true' &&
          steps.check_token.outputs.token_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN || github.token }}
          script: |
            try {
              // Test token with a simple API call to check Actions read access
              const { data: workflows } = await github.rest.actions.listRepoWorkflows({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 1
              });
              
              core.info('✓ Token has basic Actions API access');
              core.setOutput('token_valid', 'true');
              
              // Note: Write permissions cannot be fully validated until approval is attempted
            } catch (error) {
              core.error(`Token validation failed: ${error.message}`);
              core.setOutput('token_valid', 'false');
            }

      - name: Approve workflow run
        if: github.event.workflow_run.actor.login == 'github-copilot[bot]'
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.COPILOT_MCP_GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/approve

      - name: Summary
        if: always()
        run: |
          echo "## Auto-Approve Workflow Summary"
          echo ""
          echo "**Workflow Run**: ${{ github.event.workflow_run.name }} (#${{ github.event.workflow_run.id }})"
          echo "**Actor**: ${{ github.event.workflow_run.actor.login }}"
          echo "**Event Type**: ${{ github.event.workflow_run.event }}"
          echo "**Trusted Bot**: ${{ steps.check_bot.outputs.is_trusted }}"
          echo "**Token Configured**: ${{ steps.check_token.outputs.token_exists }}"
          echo "**Token Valid**: ${{ steps.validate_token.outputs.token_valid }}"
          echo ""
          
          if [ "${{ steps.check_bot.outputs.is_trusted }}" != "true" ]; then
            echo "⚠️  Actor is not a trusted bot. Auto-approval skipped."
          elif [ "${{ steps.check_token.outputs.token_exists }}" != "true" ]; then
            echo "⚠️  COPILOT_MCP_GITHUB_TOKEN not configured. Cannot approve workflow."
            echo ""
            echo "**Action Required**: Configure COPILOT_MCP_GITHUB_TOKEN as a repository secret:"
            echo "1. Create a GitHub Personal Access Token (PAT)"
            echo "   - Classic PAT: Enable 'repo' scope"
            echo "   - Fine-grained PAT: Grant Actions 'write' permission"
            echo "2. Add as repository secret: Settings → Secrets → Actions → New repository secret"
            echo "3. Name: COPILOT_MCP_GITHUB_TOKEN"
          elif [ "${{ steps.validate_token.outputs.token_valid }}" != "true" ]; then
            echo "⚠️  Token validation failed. Check token permissions."
          else
            echo "✓ Workflow approval completed successfully"
          fi
