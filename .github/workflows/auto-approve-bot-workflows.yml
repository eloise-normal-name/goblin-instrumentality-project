name: Auto-Approve Bot Workflow Runs

on:
  workflow_run:
    workflows: 
      - "Build and Validate"
      - "Run App and Log Output"
      - "Code Quality Checks"
      - "Docs Index Check"
    types: [requested]

permissions:
  actions: write
  contents: read

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    # Only approve if this is from a pull_request or push event (not workflow_dispatch)
    if: |
      github.event.workflow_run.event == 'pull_request' ||
      github.event.workflow_run.event == 'push'
    
    steps:
    - name: Check if actor is a trusted bot
      id: check_bot
      run: |
        ACTOR="${{ github.event.workflow_run.actor.login }}"
        echo "Actor: $ACTOR"
        
        # List of trusted bot accounts
        TRUSTED_BOTS="Copilot copilot[bot] copilot-swe-agent[bot] github-actions[bot]"
        
        IS_TRUSTED=false
        for bot in $TRUSTED_BOTS; do
          if [ "$ACTOR" = "$bot" ]; then
            IS_TRUSTED=true
            break
          fi
        done
        
        if [ "$IS_TRUSTED" = "true" ]; then
          echo "trusted=true" >> $GITHUB_OUTPUT
          echo "✓ Actor is a trusted bot: $ACTOR"
        else
          echo "trusted=false" >> $GITHUB_OUTPUT
          echo "✗ Actor is not a trusted bot: $ACTOR"
        fi
    
    - name: Check token configuration
      id: check_token
      if: steps.check_bot.outputs.trusted == 'true'
      env:
        TOKEN_SECRET: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN }}
      run: |
        if [ -z "$TOKEN_SECRET" ]; then
          echo "has_token=false" >> $GITHUB_OUTPUT
          echo "⚠️  COPILOT_MCP_GITHUB_TOKEN not configured. Using default GITHUB_TOKEN."
          echo "   Default token may lack permissions to approve workflow runs."
        else
          echo "has_token=true" >> $GITHUB_OUTPUT
          echo "✓ COPILOT_MCP_GITHUB_TOKEN configured"
        fi
    
    - name: Validate token permissions
      id: validate_token
      if: steps.check_bot.outputs.trusted == 'true' && steps.check_token.outputs.has_token == 'true'
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        github-token: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN }}
        script: |
          try {
            // Test token permissions with a simple read operation
            await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            core.info('✓ Token has valid Actions read permissions');
            core.setOutput('valid', 'true');
          } catch (error) {
            core.warning(`⚠️  Token validation failed: ${error.message}`);
            core.setOutput('valid', 'false');
          }
    
    - name: Approve workflow run
      if: steps.check_bot.outputs.trusted == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN || github.token }}
        script: |
          const runId = context.payload.workflow_run.id;
          const workflowName = context.payload.workflow_run.name;
          const actor = context.payload.workflow_run.actor.login;
          
          core.info(`Attempting to approve workflow run #${runId} (${workflowName}) from ${actor}`);
          
          try {
            await github.rest.actions.approveWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            core.info(`✓ Successfully approved workflow run #${runId}`);
          } catch (error) {
            if (error.status === 403) {
              core.warning('⚠️  Insufficient permissions to approve workflow run');
              core.warning('   Ensure COPILOT_MCP_GITHUB_TOKEN has Actions write permissions');
            } else if (error.message.includes('already been approved')) {
              core.info('ℹ️  Workflow run already approved');
            } else {
              core.warning(`⚠️  Failed to approve workflow run: ${error.message}`);
            }
          }
    
    - name: Summary
      if: always()
      run: |
        echo "## Auto-Approve Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_bot.outputs.trusted }}" = "true" ]; then
          echo "✓ Actor is trusted: ${{ github.event.workflow_run.actor.login }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_token.outputs.has_token }}" = "true" ]; then
            echo "✓ COPILOT_MCP_GITHUB_TOKEN configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️  Using default GITHUB_TOKEN (may lack approval permissions)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Attempted to approve workflow run #${{ github.event.workflow_run.id }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "✗ Actor not trusted: ${{ github.event.workflow_run.actor.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Auto-approval skipped for non-trusted actor" >> $GITHUB_STEP_SUMMARY
        fi
