name: Auto-Approve Bot Workflow Runs

on:
  workflow_run:
    types: [requested]
    workflows:
      - "Build and Validate"
      - "Run App and Log Output"
      - "Code Quality Checks"
      - "Docs Index Check"

permissions:
  actions: write
  contents: read

jobs:
  auto_approve:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    
    steps:
      - name: Check if run is from trusted bot
        id: check_bot
        uses: actions/github-script@v7
        with:
          script: |
            const trustedBots = [
              'Copilot',
              'copilot[bot]',
              'copilot-swe-agent[bot]',
              'github-actions[bot]'
            ];
            
            const actor = context.payload.workflow_run.actor.login;
            const actorType = context.payload.workflow_run.actor.type;
            const headRepo = context.payload.workflow_run.head_repository;
            const isFork = headRepo && headRepo.fork;
            
            core.info(`Workflow run actor: ${actor} (type: ${actorType})`);
            core.info(`Is fork: ${isFork}`);
            
            const isTrustedBot = trustedBots.includes(actor);
            
            if (isTrustedBot) {
              core.info(`Actor ${actor} is a trusted bot`);
              core.setOutput('should_approve', 'true');
            } else {
              core.info(`Actor ${actor} is not a trusted bot`);
              core.setOutput('should_approve', 'false');
            }
          result-encoding: string
      
      - name: Check if PAT is configured
        id: check_token
        env:
          PAT_TOKEN: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN }}
        run: |
          if [ -n "$PAT_TOKEN" ]; then
            echo "using_pat=true" >> $GITHUB_OUTPUT
          else
            echo "using_pat=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Approve workflow run
        if: steps.check_bot.outputs.should_approve == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN || github.token }}
          script: |
            const runId = context.payload.workflow_run.id;
            const actor = context.payload.workflow_run.actor.login;
            const usingPAT = '${{ steps.check_token.outputs.using_pat }}' === 'true';
            
            if (usingPAT) {
              core.info(`Attempting to approve workflow run ${runId} from ${actor} using COPILOT_MCP_GITHUB_TOKEN (PAT)`);
            } else {
              core.warning(`COPILOT_MCP_GITHUB_TOKEN secret not configured - using default GITHUB_TOKEN`);
              core.warning(`Default token may have insufficient permissions to approve workflow runs`);
              core.warning(`To fix: Add COPILOT_MCP_GITHUB_TOKEN secret with 'repo' scope (classic PAT) or Actions 'write' permission (fine-grained PAT)`);
              core.info(`Attempting to approve workflow run ${runId} from ${actor} using GITHUB_TOKEN`);
            }
            
            try {
              await github.rest.actions.approveWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });
              
              core.info(`âœ“ Successfully approved workflow run ${runId} from ${actor}`);
            } catch (error) {
              // If approval fails (e.g., already approved, not needed, or insufficient permissions)
              if (error.status === 403) {
                core.error(`Permission denied - COPILOT_MCP_GITHUB_TOKEN secret required for approval`);
                core.error(`Configure a Personal Access Token with 'repo' scope (classic) or Actions 'write' permission (fine-grained) as COPILOT_MCP_GITHUB_TOKEN secret`);
              } else {
                core.warning(`Could not approve workflow run ${runId}: ${error.message}`);
              }
            }
