name: Auto-Approve Bot Workflow Runs

on:
  workflow_run:
    types: [requested]
    workflows:
      - "Build and Validate"
      - "Run App and Log Output"
      - "Code Quality Checks"
      - "Docs Index Check"

permissions:
  actions: write
  contents: read

jobs:
  auto_approve:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    
    steps:
      - name: Check if run is from trusted bot
        id: check_bot
        uses: actions/github-script@v7
        with:
          script: |
            const trustedBots = [
              'Copilot',
              'copilot[bot]',
              'copilot-swe-agent[bot]',
              'github-actions[bot]'
            ];
            
            const actor = context.payload.workflow_run.actor.login;
            const actorType = context.payload.workflow_run.actor.type;
            const headRepo = context.payload.workflow_run.head_repository;
            const isFork = headRepo && headRepo.fork;
            
            core.info(`Workflow run actor: ${actor} (type: ${actorType})`);
            core.info(`Is fork: ${isFork}`);
            
            const isTrustedBot = trustedBots.includes(actor);
            
            if (isTrustedBot) {
              core.info(`Actor ${actor} is a trusted bot`);
              core.setOutput('should_approve', 'true');
            } else {
              core.info(`Actor ${actor} is not a trusted bot`);
              core.setOutput('should_approve', 'false');
            }
          result-encoding: string
      
      - name: Check MCP token permissions
        id: check_token
        if: steps.check_bot.outputs.should_approve == 'true'
        env:
          MCP_TOKEN: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN || github.token }}
          script: |
            const token = process.env.MCP_TOKEN;
            
            if (!token) {
              core.warning('⚠️ COPILOT_MCP_GITHUB_TOKEN secret is not configured');
              core.warning('The workflow will not be able to approve runs from bot PRs');
              core.warning('To fix: Configure a GitHub PAT with Actions write permission as COPILOT_MCP_GITHUB_TOKEN secret');
              core.setOutput('has_token', 'false');
              return;
            }
            
            core.info('✓ COPILOT_MCP_GITHUB_TOKEN secret is configured');
            
            // Try to validate token permissions by making a test API call
            // The github object is authenticated with the MCP token via github-token parameter
            try {
              // Test basic Actions read permission (write permission for approval cannot be tested without attempting approval)
              await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 1
              });
              
              core.info('✓ Token has valid Actions read permissions');
              core.info('Note: Write permissions for approval will be verified during actual approval attempt');
              core.setOutput('has_token', 'true');
            } catch (error) {
              core.warning(`⚠️ Token validation failed: ${error.message}`);
              core.warning('Token may lack required permissions (needs Actions write for approval)');
              core.setOutput('has_token', 'false');
            }
          result-encoding: string
      
      - name: Approve workflow run
        if: steps.check_bot.outputs.should_approve == 'true' && steps.check_token.outputs.has_token == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN }}
          script: |
            const runId = context.payload.workflow_run.id;
            const actor = context.payload.workflow_run.actor.login;
            
            core.info(`Attempting to approve workflow run ${runId} from ${actor} using COPILOT_MCP_GITHUB_TOKEN`);
            
            try {
              await github.rest.actions.approveWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });
              
              core.info(`✓ Successfully approved workflow run ${runId} from ${actor}`);
            } catch (error) {
              // If approval fails (e.g., already approved or not needed), log but don't fail
              core.warning(`Could not approve workflow run ${runId}: ${error.message}`);
            }
