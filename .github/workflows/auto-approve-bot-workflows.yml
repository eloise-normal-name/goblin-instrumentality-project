name: Auto-Approve Bot Workflow Runs

on:
  workflow_run:
    types: [requested]
    workflows:
      - "Build and Validate"
      - "Run App and Log Output"

permissions:
  actions: write
  contents: read

jobs:
  auto_approve:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    
    steps:
      - name: Check if run is from trusted bot
        id: check_bot
        uses: actions/github-script@v7
        with:
          script: |
            const trustedBots = [
              'copilot',
              'copilot-swe-agent',
              'github-actions'
            ];
            
            const actor = context.payload.workflow_run.actor.login;
            const headRepo = context.payload.workflow_run.head_repository;
            const isFork = headRepo && headRepo.fork;
            
            core.info(`Workflow run actor: ${actor}`);
            core.info(`Is fork: ${isFork}`);
            
            const isTrustedBot = trustedBots.includes(actor);
            
            if (isTrustedBot) {
              core.info(`Actor ${actor} is a trusted bot`);
              core.setOutput('should_approve', 'true');
            } else {
              core.info(`Actor ${actor} is not a trusted bot`);
              core.setOutput('should_approve', 'false');
            }
          result-encoding: string
      
      - name: Approve workflow run
        if: steps.check_bot.outputs.should_approve == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const actor = context.payload.workflow_run.actor.login;
            
            try {
              await github.rest.actions.approveWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });
              
              core.info(`Successfully approved workflow run ${runId} from ${actor}`);
            } catch (error) {
              // If approval fails (e.g., already approved or not needed), log but don't fail
              core.warning(`Could not approve workflow run ${runId}: ${error.message}`);
            }