name: Generate Highlights Report

on:
  workflow_dispatch:
    inputs:
      base_commit:
        description: 'Base commit for comparison (default: last highlights commit)'
        required: false
        type: string

jobs:
  generate-report:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for git log
      
    - name: Determine base commit
      id: base
      run: |
        if ("${{ inputs.base_commit }}" -ne "") {
          $base = "${{ inputs.base_commit }}"
        } else {
          # Find last commit that modified refactor-highlights.html
          $base = git log --all --pretty=format:%H -- refactor-highlights.html | Select-Object -First 1
          if (!$base) {
            $base = git rev-list --max-parents=0 HEAD
          }
        }
        Write-Output "Base commit: $base"
        Write-Output "BASE_COMMIT=$base" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: Get file stats
      id: stats
      run: |
        $changed = git diff --name-only $env:BASE_COMMIT HEAD | Measure-Object | Select-Object -ExpandProperty Count
        Write-Output "FILES_CHANGED=$changed" >> $env:GITHUB_ENV
        Write-Output "Files changed: $changed"
      shell: pwsh
      
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
      
    - name: Build MinSizeRel
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64
        cmake --build build --config MinSizeRel
      
    - name: Get binary size
      id: binary
      run: |
        $size = (Get-Item "bin/MinSizeRel/goblin-stream.exe").Length
        Write-Output "BINARY_SIZE=$size" >> $env:GITHUB_ENV
        Write-Output "Binary size: $size bytes"
      shell: pwsh
      
    - name: Install cloc
      run: choco install cloc -y
      
    - name: Count source lines
      id: cloc
      run: |
        $output = cloc src --json
        $json = $output | ConvertFrom-Json
        $total = $json.SUM.code
        Write-Output "SOURCE_LINES=$total" >> $env:GITHUB_ENV
        Write-Output "Source lines: $total"
      shell: pwsh
      
    - name: Create highlights comment
      run: |
        $date = Get-Date -Format "yyyy-MM-dd"
        Write-Output "### Refactor Highlights Report" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "**Generated**: $date" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "**Base commit**: $env:BASE_COMMIT" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "#### Metrics" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- Files changed: $env:FILES_CHANGED" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- MinSizeRel binary: $env:BINARY_SIZE bytes" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "- Source lines (/src): $env:SOURCE_LINES" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "" >> $env:GITHUB_STEP_SUMMARY
        Write-Output "#### Changed Files" >> $env:GITHUB_STEP_SUMMARY
        git diff --name-only $env:BASE_COMMIT HEAD | ForEach-Object { Write-Output "- $_" >> $env:GITHUB_STEP_SUMMARY }
      shell: pwsh
