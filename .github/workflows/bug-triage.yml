name: Bug Triage & Assignment

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  issues:
    types: [opened, labeled]
  workflow_dispatch:

jobs:
  triage-bugs:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      repository-projects: write
    env:
      GITHUB_TOKEN: ${{ secrets.COPILOT_MCP_GITHUB_TOKEN || github.token }}
    steps:
      - name: Check token configuration
        run: |
          if [ -z "${{ secrets.COPILOT_MCP_GITHUB_TOKEN }}" ]; then
            echo "⚠️  COPILOT_MCP_GITHUB_TOKEN not configured. Using default GITHUB_TOKEN."
            echo "Some project board operations may fail due to permission limitations."
          else
            echo "✓ COPILOT_MCP_GITHUB_TOKEN configured for enhanced permissions"
          fi

      - name: Query open bugs
        id: query_bugs
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          result-encoding: json
          script: |
            const query = `
              query {
                search(query: "repo:${{ github.repository }} is:issue is:open label:bug", type: ISSUE, first: 20) {
                  edges {
                    node {
                      ... on Issue {
                        number
                        title
                        body
                        labels(first: 10) {
                          nodes {
                            name
                          }
                        }
                        author {
                          login
                        }
                        createdAt
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query);
            const bugs = result.search.edges.map(e => e.node);
            
            core.setOutput('bugs', JSON.stringify(bugs));
            core.info(`Found ${bugs.length} open bugs for triage`);
            
            return bugs;

      - name: Triage and assign bugs
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          script: |
            const bugs = JSON.parse('${{ steps.query_bugs.outputs.bugs }}');
            
            if (bugs.length === 0) {
              core.info('No open bugs found. Bug triage is up to date!');
              return;
            }

            core.info(`Processing ${bugs.length} bugs for triage and assignment`);

            for (const bug of bugs) {
              // Skip if already assigned to an agent (has agent-assigned label)
              const hasAssignment = bug.labels.nodes.some(l => l.name.startsWith('agent:'));
              if (hasAssignment) {
                core.info(`Issue #${bug.number} already assigned. Skipping.`);
                continue;
              }

              // Determine bug category from title and labels
              const title = bug.title.toLowerCase();
              const labels = bug.labels.nodes.map(l => l.name.toLowerCase());
              
              let assignedAgent = null;
              let context = '';

              // Route to appropriate agent based on keywords
              if (title.includes('crash') || title.includes('exception') || 
                  labels.some(l => l.includes('critical'))) {
                assignedAgent = 'review-error-handling';
                context = 'Critical crash or exception detected';
              } else if (title.includes('leak') || title.includes('memory') || 
                        title.includes('raii') || labels.some(l => l.includes('memory'))) {
                assignedAgent = 'check-raii';
                context = 'Resource management or memory leak suspected';
              } else if (title.includes('frame') || title.includes('command') || 
                        title.includes('d3d12') || labels.some(l => l.includes('graphics'))) {
                assignedAgent = 'review-frame-logic';
                context = 'D3D12 frame submission or command issue';
              } else if (title.includes('nvenc') || title.includes('encode') || 
                        labels.some(l => l.includes('encoder'))) {
                assignedAgent = 'explain-nvenc';
                context = 'NVENC encoding or interop issue';
              } else if (title.includes('debug') || title.includes('resource') || 
                        title.includes('state')) {
                assignedAgent = 'debug-resources';
                context = 'GPU resource state or diagnostics issue';
              }

              if (assignedAgent) {
                // Add assignment comment
                const lines = [
                  '## Triage Assignment',
                  '',
                  `**Assigned to**: @clp /agent ${assignedAgent}`,
                  '',
                  `**Analysis Context**: ${context}`,
                  '',
                  '**Issue Details**:',
                  `- Title: ${bug.title}`,
                  `- Reporter: @${bug.author.login}`,
                  `- Created: ${new Date(bug.createdAt).toLocaleDateString()}`,
                  '',
                  '**Please analyze**:',
                  '1. Reproduce the issue using the steps provided in the issue description',
                  '2. Identify the root cause',
                  '3. Propose a fix with specific file and line references',
                  '4. Recommend testing approach',
                  '',
                  '*Auto-triaged by BugBot. See `.github/agents/bugbot.agent.md` for triage criteria.*'
                ];
                const comment = lines.join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: bug.number,
                  body: comment
                });

                // Add component label if identified
                const allLabels = bug.labels.nodes.map(l => l.name);
                if (!allLabels.some(l => ['graphics', 'encoder', 'nvenc', 'app'].includes(l))) {
                  if (assignedAgent === 'review-frame-logic') {
                    allLabels.push('graphics');
                  } else if (assignedAgent === 'explain-nvenc') {
                    allLabels.push('encoder');
                  } else if (assignedAgent === 'debug-resources') {
                    allLabels.push('graphics');
                  }
                }

                // Add agent assignment label (informational)
                allLabels.push(`agent:${assignedAgent}`);
                allLabels.push('triage:in-progress');

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: bug.number,
                  labels: [...new Set(allLabels)]
                });

                core.info(`✓ Issue #${bug.number}: Assigned to ${assignedAgent}`);
              } else {
                core.info(`⚠️  Issue #${bug.number}: Could not determine routing. Needs manual review.`);
              }
            }

      - name: Summary
        if: always()
        run: |
          echo "## Bug Triage Run Complete"
          echo ""
          echo "✓ Queried open bugs"
          echo "✓ Assigned bugs to appropriate agents"
          echo "✓ Updated issue labels and comments"
          echo ""
          echo "**Next Steps**:"
          echo "- Agents will analyze assigned bugs"
          echo "- Check issue comments for agent findings"
          echo "- Labels track triage status: \`agent:*\`, \`triage:*\`"
          echo ""
          echo "For manual bug assignments, use:"
          echo "\`\`\`"
          echo "@clp /agent <agent-name>"
          echo "\`\`\`"
