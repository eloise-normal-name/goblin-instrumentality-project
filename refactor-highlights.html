<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goblin Instrumentality Project - Highlights</title>
    <style>
        :root {
            color-scheme: light;
        }

        body {
            margin: 0;
            background: #0f172a;
            color: #e2e8f0;
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
            line-height: 1.5;
        }

        main {
            max-width: 1000px;
            margin: 0 auto;
            padding: 28px;
        }

        h1 {
            margin: 0 0 8px;
            font-size: 2rem;
            color: #f8fafc;
        }

        .subtitle {
            margin: 0 0 24px;
            color: #94a3b8;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .card {
            background: #111827;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 14px;
        }

        .card .k {
            font-size: 0.82rem;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.05em;
        }

        .card .v {
            margin-top: 6px;
            font-size: 1.3rem;
            color: #f8fafc;
            font-weight: 700;
        }

        .code-cards {
            display: grid;
            gap: 12px;
        }

        details {
            background: #111827;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 12px 14px;
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            color: #f8fafc;
        }

        .code-card {
            margin-top: 10px;
            border: 1px solid #1e293b;
            border-radius: 8px;
            background: #0b1120;
            padding: 12px;
        }

        .code-card code {
            color: #e2e8f0;
        }

        .code-card .kw {
            color: #93c5fd;
        }

        .code-card .type {
            color: #c4b5fd;
        }

        .code-card .num {
            color: #facc15;
        }

        section {
            margin: 24px 0;
        }

        h2 {
            color: #f8fafc;
            margin: 0 0 10px;
            font-size: 1.2rem;
        }

        .panel {
            background: #111827;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 14px;
        }

        ul {
            margin: 8px 0 0 18px;
            padding: 0;
        }

        li {
            margin: 7px 0;
        }

        pre {
            margin: 0;
            overflow-x: auto;
            background: #020617;
            border: 1px solid #1e293b;
            border-radius: 8px;
            padding: 12px;
            color: #cbd5e1;
        }

        code {
            font-family: Consolas, "Cascadia Mono", monospace;
            font-size: 0.88rem;
        }

        .small {
            color: #94a3b8;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <main>
        <h1>Refactor Highlights since <code>715fe60</code></h1>
        <p class="subtitle">Compared range: <code>715fe60..HEAD</code> · generated on 2026-02-19</p>

        <div class="cards">
            <div class="card">
                <div class="k">Files changed</div>
                <div class="v">4</div>
            </div>
            <div class="card">
                <div class="k">Insertions / Deletions</div>
                <div class="v">App run-loop readability refactor</div>
            </div>
            <div class="card">
                <div class="k">MinSizeRel binary</div>
                <div class="v">155,136 bytes</div>
            </div>
            <div class="card">
                <div class="k">cloc total in /src</div>
                <div class="v">1688 lines</div>
            </div>
        </div>

        <section>
            <h2>High-level goal alignment</h2>
            <div class="panel">
                <p>
                    The active track is reducing cognitive load in the frame loop while preserving exact render/encode
                    behavior. This delta keeps the system architecture intact but moves repetitive concerns out of
                    <code>App::Run()</code>: logging moved to <code>app_logging</code>, constant-buffer updates are now
                    encapsulated in a helper struct, and message pumping has a dedicated method.
                </p>
            </div>
        </section>

        <section>
            <h2>What changed and why</h2>
            <div class="panel">
                <ul>
                    <li>Extracted frame-loop logging helpers into <code>src/app_logging.h/.cpp</code> so <code>App</code> orchestration code stays focused on flow control.</li>
                    <li>Refactored constant-buffer ownership and writes into nested <code>MvpConstantBuffer</code> with RAII map/unmap and <code>WriteIdentity()</code>.</li>
                    <li>Converted frame-wait callbacks to lambdas configured in one place inside <code>FrameWaitCoordinator::Wait</code>.</li>
                    <li>Moved Win32 message pumping into <code>PumpMessages(bool&amp; running)</code> to simplify <code>Run()</code>.</li>
                    <li>Added <code>src/app_logging.cpp</code> to <code>CMakeLists.txt</code> and fixed a MinSizeRel linker issue by defaulting <code>~App()</code> in-class.</li>
                </ul>
            </div>
        </section>

        <section>
            <h2>Snippets in context</h2>
            <div class="code-cards">
                <details>
                    <summary>Logging extracted out of App::Run</summary>
                    <div class="code-card">
                        <pre><code><span class="kw">auto</span> frame_log = AppLogging::BuildFrameLogContext(frames_submitted, last_frame_time);
AppLogging::LogFrameLoopStart(frame_log, frame_encoder.GetStats());
...
AppLogging::LogFenceCompletion(frame_log, completed_value);
AppLogging::LogPresentStatus(frame_log, present_result);
...</code></pre>
                    </div>
                </details>
                <details>
                    <summary>MVP constant buffer now has RAII helper</summary>
                    <div class="code-card">
                        <pre><code><span class="kw">struct</span> <span class="type">MvpConstantBuffer</span> {
    <span class="type">ComPtr&lt;ID3D12Resource&gt;</span> resource;
    uint8_t* mapped = <span class="kw">nullptr</span>;
    ~MvpConstantBuffer() { <span class="kw">if</span> (resource &amp;&amp; mapped) resource-&gt;Unmap(<span class="num">0</span>, <span class="kw">nullptr</span>); }
    <span class="kw">void</span> WriteIdentity() { memcpy(mapped, &amp;IDENTITY, sizeof(IDENTITY)); }
};</code></pre>
                    </div>
                </details>
                <details>
                    <summary>Wait callbacks + message pump cleanup</summary>
                    <div class="code-card">
                        <pre><code>.on_complete = [](App&amp; current_app) {
    current_app.bitstream_writer.DrainCompleted();
    <span class="kw">return</span> FrameLoopAction::Continue;
};

<span class="kw">if</span> (frame_wait_coordinator.Wait(*<span class="kw">this</span>, frame_log.frame, frame_log.cpu_ms)
    == FrameLoopAction::Continue) {
    PumpMessages(running);
    <span class="kw">continue</span>;
}</code></pre>
                    </div>
                </details>
                <details>
                    <summary>References and guides</summary>
                    <div class="code-card">
                        <pre><code>- .github/prompts/snippets/nvenc-guide.md
- https://docs.nvidia.com/video-technologies/video-codec-sdk/13.0/
  nvenc-video-encoder-api-prog-guide/index.html</code></pre>
                    </div>
                </details>
            </div>
        </section>

        <section>
            <h2>Build and validation status</h2>
            <div class="panel">
                <ul>
                    <li>MinSizeRel build: successful (<code>goblin-stream.vcxproj -&gt; bin/MinSizeRel/goblin-stream.exe</code>).</li>
                    <li>Binary size (MinSizeRel): <code>155,136</code> bytes.</li>
                    <li>cloc /src total: <code>1688</code> lines.</li>
                    <li>Diagnostics check: no blocking errors after the destructor linkage fix and logging warning guards.</li>
                    <li>Check used for this entry: <code>cmake --build build --config MinSizeRel</code>.</li>
                </ul>
                <p class="small">Environment note: MinSizeRel build must run inside VS18 developer shell or equivalent configured environment.</p>
            </div>
        </section>

        <section>
            <h2>Scope note</h2>
            <div class="panel">
                <p>This highlights update focuses on the current staged refactor delta in runtime code:</p>
                <ul>
                    <li><code>src/app.ixx</code></li>
                    <li><code>src/app_logging.cpp</code> and <code>src/app_logging.h</code></li>
                    <li><code>CMakeLists.txt</code></li>
                    <li><code>refactor-highlights.html</code></li>
                </ul>
                <p class="small">Baseline commit used for broad comparison lookup: <code>715fe60</code> (latest prior highlights commit).</p>
            </div>
        </section>

        <section>
            <h2>Build log</h2>
            <div class="panel">
                <ul>
                    <li>2026-02-19 · MinSizeRel size: <code>155,136</code> bytes · cloc /src: <code>1688</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>281,600</code> bytes · cloc /src: <code>1244</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>281,600</code> bytes · cloc /src: <code>1244</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>281,600</code> bytes · cloc /src: <code>1244</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>281,600</code> bytes · cloc /src: <code>1244</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>281,600</code> bytes · cloc /src: <code>1244</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>281,600</code> bytes · cloc /src: <code>1244</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>281,600</code> bytes · cloc /src: <code>1244</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>281,600</code> bytes · cloc /src: <code>1257</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>281,600</code> bytes · cloc /src: <code>1257</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>281,600</code> bytes · cloc /src: <code>1257</code> lines · build succeeded.</li>
                    <li>2026-02-15 · MinSizeRel size: <code>282,624</code> bytes · cloc /src: <code>1252</code> lines · build succeeded.</li>
                    <li>2026-02-14 · MinSizeRel size: <code>282,112</code> bytes · cloc /src: <code>1252</code> lines · build succeeded.</li>
                    <li>2026-02-14 · MinSizeRel size: <code>282,112</code> bytes · cloc /src: <code>1252</code> lines · build succeeded.</li>
                    <li>2026-02-12 · MinSizeRel size: <code>266,752</code> bytes · cloc /src: <code>913</code> lines · build succeeded.</li>
                    <li>2026-02-13 · MinSizeRel size: <code>267,264</code> bytes · cloc /src: <code>923</code> lines · build succeeded.</li>
                </ul>
            </div>
        </section>

        <section>
            <h2>Proposed next steps</h2>
            <div class="panel">
                <ul>
                    <li>Move the <code>wait_for_frame</code> logging calls from <code>app.ixx</code> into <code>app_logging</code> to fully centralize frame-loop logs.</li>
                    <li>Consider extracting RTV heap / command-list bootstrap from <code>App</code> into a small render-setup helper for constructor readability.</li>
                    <li>Add one regression test/checklist item for MinSizeRel linkage (to catch duplicate symbol regressions quickly).</li>
                </ul>
            </div>
        </section>
    </main>
</body>
</html>
